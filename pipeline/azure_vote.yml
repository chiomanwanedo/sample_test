resources:
  repositories:
    - repository: voting-app
      type: github
      name: chiomanwanedo/example-voting-app
      endpoint: github  # Replace with your actual GitHub service connection name

trigger:
  branches:
    include:
      - main
  paths:
    exclude:
      - k8s-specifications/*.yaml

variables:
  IMAGE_TAG: $[variables['Build.BuildId']]
  REPO_PATH: 'k8s-specifications'
  VOTE_FILE: 'vote-deployment.yaml'
  RESULT_FILE: 'result-deployment.yaml'
  WORKER_FILE: 'worker-deployment.yaml'

pool:
  name: Default

stages:

  # -------------------------------------- #
  #  Stage 1: Build and Push Docker Images #
  # -------------------------------------- #
  - stage: BuildAndPush
    displayName: "Build and Push Docker Images"
    condition: succeeded()
    jobs:
      - job: BuildImages
        steps:
          - checkout: self
          - checkout: voting-app
            path: voting-app

          - script: |
              echo "üß™ Verifying Dockerfile paths:"
              find $(Build.SourcesDirectory)/../voting-app -name Dockerfile
            displayName: "Debug Dockerfile Paths"

          - task: Docker@2
            displayName: "Build and Push 'vote'"
            inputs:
              containerRegistry: 'dockeracr'
              repository: 'vote'
              command: 'buildAndPush'
              Dockerfile: '$(Build.SourcesDirectory)/../voting-app/vote/Dockerfile'
              buildContext: '$(Build.SourcesDirectory)/../voting-app/vote'
              tags: |
                $(IMAGE_TAG)
                latest

          - task: Docker@2
            displayName: "Build and Push 'result'"
            inputs:
              containerRegistry: 'dockeracr'
              repository: 'result'
              command: 'buildAndPush'
              Dockerfile: '$(Build.SourcesDirectory)/../voting-app/result/Dockerfile'
              buildContext: '$(Build.SourcesDirectory)/../voting-app/result'
              tags: |
                $(IMAGE_TAG)
                latest

          - task: Docker@2
            displayName: "Build and Push 'worker'"
            inputs:
              containerRegistry: 'dockeracr'
              repository: 'worker'
              command: 'buildAndPush'
              Dockerfile: '$(Build.SourcesDirectory)/../voting-app/worker/Dockerfile'
              buildContext: '$(Build.SourcesDirectory)/../voting-app/worker'
              tags: |
                $(IMAGE_TAG)
                latest

  # -------------------------------------- #
  #  Stage 2: Update Kubernetes Manifests  #
  # -------------------------------------- #
  - stage: UpdateManifests
    displayName: "Update K8s Manifests & Push"
    dependsOn: BuildAndPush
    condition: succeeded()
    jobs:
      - job: UpdateYaml
        steps:
          - checkout: self
          - checkout: voting-app
            path: voting-app

          - script: |
              echo "üîß Updating image tags to :$(IMAGE_TAG)"
              sed -i "s#chiomaacr.azurecr.io/vote:.*#chiomaacr.azurecr.io/vote:$(IMAGE_TAG)#g" $(Build.SourcesDirectory)/../voting-app/$REPO_PATH/$VOTE_FILE
              sed -i "s#chiomaacr.azurecr.io/result:.*#chiomaacr.azurecr.io/result:$(IMAGE_TAG)#g" $(Build.SourcesDirectory)/../voting-app/$REPO_PATH/$RESULT_FILE
              sed -i "s#chiomaacr.azurecr.io/worker:.*#chiomaacr.azurecr.io/worker:$(IMAGE_TAG)#g" $(Build.SourcesDirectory)/../voting-app/$REPO_PATH/$WORKER_FILE

              echo "üîç Showing manifest diff:"
              git -C $(Build.SourcesDirectory)/../voting-app diff $REPO_PATH/
            displayName: "Update Image Tags in YAML Files"

          - script: |
              cd $(Build.SourcesDirectory)/../voting-app
              git config user.email "chiomavanessa8@gmail.com"
              git config user.name "chiomanwanedo"
              git add $REPO_PATH/*.yaml
              git commit -m "Update image tags to :$(IMAGE_TAG) [skip ci]" || echo "No changes to commit"
              git push origin main
            displayName: "Commit and Push Updated YAML Files"

  # -------------------------------------- #
  #  Stage 3: Deploy to Kubernetes Cluster #
  # -------------------------------------- #
  - stage: DeployToK8s
    displayName: "Deploy Updated YAMLs to Kubernetes"
    dependsOn: UpdateManifests
    condition: succeeded()
    jobs:
      - job: DeployK8s
        steps:
          - checkout: self
          - checkout: voting-app
            path: voting-app

          - script: |
              mkdir -p ~/.kube
              echo "$(KUBECONFIG_CONTENT)" > ~/.kube/config
              chmod 600 ~/.kube/config
            displayName: "Set Up Kubeconfig"

          - script: |
              for f in $REPO_PATH/$VOTE_FILE $REPO_PATH/$RESULT_FILE $REPO_PATH/$WORKER_FILE; do
                echo "üöÄ Applying: $(Build.SourcesDirectory)/../voting-app/$f"
                kubectl apply -f $(Build.SourcesDirectory)/../voting-app/$f || { echo "‚ö†Ô∏è Retry: $f"; sleep 5; kubectl apply -f $(Build.SourcesDirectory)/../voting-app/$f; }
              done
            displayName: "Apply Updated Manifests to Cluster"
