trigger:
  branches:
    include:
      - main

resources:
  repositories:
    - repository: votingapp
      type: github
      name: chiomanwanedo/example-voting-app
      ref: main
      endpoint: github.com_chiomanwanedo  # ✅ Replace with your GitHub service connection name if needed

variables:
  IMAGE_TAG: $(Build.BuildId)

stages:
  - stage: BuildAndPush
    displayName: Build and Push Docker Images to ACR
    jobs:
      - job: PushImages
        displayName: Build & Push vote, result, and worker
        pool:
          name: Default  # ✅ Replace if your self-hosted agent pool has a different name
        steps:
          # ✅ Checkout the GitHub repo into the 'src' folder to avoid nested path issues
          - checkout: votingapp
            path: src

          # ✅ Build and push 'vote' image
          - task: Docker@2
            displayName: Build and Push 'vote' image
            inputs:
              containerRegistry: 'dockeracr'  # ✅ Replace with your ACR service connection name
              repository: 'vote'
              command: 'buildAndPush'
              Dockerfile: 'src/vote/Dockerfile'
              tags: |
                $(IMAGE_TAG)

          # ✅ Build and push 'result' image
          - task: Docker@2
            displayName: Build and Push 'result' image
            inputs:
              containerRegistry: 'dockeracr'
              repository: 'result'
              command: 'buildAndPush'
              Dockerfile: 'src/result/Dockerfile'
              tags: |
                $(IMAGE_TAG)

          # ✅ Build and push 'worker' image
          - task: Docker@2
            displayName: Build and Push 'worker' image
            inputs:
              containerRegistry: 'dockeracr'
              repository: 'worker'
              command: 'buildAndPush'
              Dockerfile: 'src/worker/Dockerfile'
              tags: |
                $(IMAGE_TAG)
