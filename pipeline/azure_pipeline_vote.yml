---
trigger:
  branches:
    include:
      - main
  paths:
    include:
      - example-voting-app/vote/**
      - example-voting-app/k8s-specifications/vote-deployment.yaml

name: vote-pipeline-$(Date:yyyyMMdd)$(Rev:.r)

variables:
  imageName: vote
  tag: $(Build.BuildId)
  containerRegistry: chiomaacr.azurecr.io
  gitUsername: $(GITHUB_USERNAME)
  gitToken: $(GITHUB_TOKEN)

stages:
  - stage: BuildAndPush
    jobs:
      - job: Build
        pool:
          name: Default
        steps:
          - checkout: self

          - task: Bash@3
            displayName: "üìÅ Tree: Show folder structure"
            inputs:
              targetType: inline
              script: |
                echo "üìÅ Showing all files under Build.SourcesDirectory:"
                find "$(Build.SourcesDirectory)" -type f

          - task: Bash@3
            displayName: "Debug:Check Dockerfile"
            inputs:
              targetType: inline
              script: |
                echo "üîç Checking Dockerfile location..."
                ls -l "$(Build.SourcesDirectory)/example-voting-app/vote/Dockerfile"

          - task: Docker@2
            displayName: Build and Push Docker image
            inputs:
              containerRegistry: dockeracr
              repository: $(imageName)
              command: buildAndPush
              Dockerfile: "$(Build.SourcesDirectory)/example-voting-app/vote/Dockerfile"
              tags: |
                $(tag)

  - stage: UpdateK8sYaml
    dependsOn: BuildAndPush
    jobs:
      - job: PatchYAML
        pool:
          name: Default
        steps:
          - task: Bash@3
            displayName: "Patch vote-deployment.yaml"
            inputs:
              targetType: inline
              script: |
                cd "$(Build.SourcesDirectory)/example-v
